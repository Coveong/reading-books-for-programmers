# 5장 구부러지거나 부러지거나

되돌릴 수 있는 의사 결정을 내릴 수 있는 구체적인 방법에 대해 알면 코드가 불확실한 세상에 닥쳐서도 유연성과 적응성을 잃지 않게 될 것입니다.

## 결합도 줄이기와 디미터 법칙

'부끄럼을 타는'이란 자신을 남에게 속속들이 드러내지 말고, 너무 많은 사람과 상호작용하지 말라는 두 가지 의미를 모두 내포합니다.

어떤 객체에게 특정 서비스를 요청했을 때, 이 요청을 바로 처리해주길 바라지, 제 3의 객체를 넘겨 받아 이미 요청한 서비스를 가지고 이러쿵저러쿵 하고 싶지는 않을 것입니다.

🤔 그럼, 왜 의존의 증가가 나쁜 것일까요?

→ 시스템 어딘가의 무관한 변화가 코드에 영향을 미칠 수 있는 위험이 커지기 때문입니다.

직접 객체간의 관계를 해집고 다닌다면 의존 관계가 조합적으로 폭발하는데 이런 형산의 징후는 다양한 방식으로 나타납니다.

1. 단위 테스트를 링크하기 위한 명령어가 테스트 프로그램 자체보다 긴 대규모 C 혹은 C++ 프로젝트
2. 한 모듈의 '간단한' 수정이 이와 관계없는 모듈을 통해 시스템 전역에 퍼져나가는 경우
3. **개발자가 수정한 부분이 시스템에 어떤 영향을 미칠지 몰라 코드의 수정을 두려워하는 경우**

이러한 의존도를 최소화하기 위해 디미터 법칙을 사용해 메서드, 함수를 설계해야 합니다.

### 디미터 함수 법칙

프로그램에서 모듈간 결합도를 최소화하려 시도하는 법칙으로 한 객체가 제공하는 메서드에 접근하기 위해 또 다른 객체들을 통하는 것을 허용하지 않습니다.

```
📌  모듈간의 결합도를 최소화하라.
```

🤔  디미터 법칙을 따른다면 정말 한층 유지보수하기 좋은 코드를 생성할 수 있나요?

→ 함수를 호출하는 클래스의 응답집합 크기를 줄일 수 있기 때문에 좀 더 에러가 적은 클래스들을 만들 수 있습니다.

이때, 응답집합이란 클래스의 메서드가 직접 호출하는 함수의 수를 의미하고 연구에 따르면, 이 응답집합이 큰 클래슨느 작은 클래스보다 에러를 발생시키기 쉽다고 합니다.

하지만 디미터 법칙의 단점도 존재합니다.

코드를 더 적응성 있고 강하게 만들어 주지만 '주계약자'로서의 대가를 치러야 하기 때문입니다.

위임 메서드는 성능 저하와 메서리 과부하와 같은 문제를 야기할 수 있는데, 이러한 문제는 어떤 종류의 애플리케이션에서는 심각할 수도 있고, 심지어 설대 금해야 하는 것일 수도 있습니다.

때론, 디미터 법칙과 반대로 여러 모듈의 결합도를 높힘으로써 중요한 성능향상을 꾀할 수도 있습니다.

장점과 단점을 잘 고려해야 합니다.

## 메타프로그래밍

세부사항은 우리의 깔끔한 코드를 어질러 놓습니다. 

세부사항을 모드에서 몰아내면 코드는 매우 설정 가능하게 되고 소프트 해질 것 입니다. 즉, 변화에 쉽게 적응할 수 있게 될 것입니다.

### 동적 설정

시스템을 되도록 설정가능하게 만들어야 합니다. 

```
📌  통합하지 말고 설정하라.
```

메타데이터를 이용해 반환 매개 변수, 사용자 선호사항, 설치 디렉터리와 같은 애플리케이션 설정 옵션을 기술해야 합니다.

🤔  메타데이터란 무엇인가요?

→ 데이터에 관한 데이터입니다. 좀 더 넓은 의미로는 애플리케이션을 기술하는 모든 데이터입니다.

보통 메타데이터는 컴파일타임이 아닌 런타임에 접근, 사용됩니다.

### 메타데이터 주도 애플리케이션

가능한 많은 메타데이터를 사용해 ㅅ애플리케이션을 설정하고 실행시켜야합니다. 

목표는 선언적으로 생각하는 것이고, 이로써 더 동적이고 적응간으한 프로그램을 만든는 것입니다.

**일반적인 경우에 대해서 프로그램을 만들고, 특별한 것들은 컴파일된 코드 밖 어딘가에 내놓는 규칙**을 따라야 합니다.

```
📌  코드에는 추상화를, 메타데이터에는 세부 내용을.
```

- 설계의 결합도를 중려 유연하고 적응성 있는 프로그램 만들 수 있습니다.
- 세부사항을 코드 밖으로 몰아내으로써 보다 강하고 추상적인 디자인을 만들 수 있다.
- 애플리케이션을 커스터마이징하기 위해 다시 컴파일할 필요가 없다.
- 메타데이터는 범용 프로그래밍 언어보다 문제 도메인에 가까운 방식으로 표현될 수 있다.
- 동일한 애플리케이션 엔진과 상이한 메타데이터를 이용해 여러 다른 프로젝트를 진행할 수 있다.

가능한 마지막 순간까지 세부 정의를 피하고, 세부사항을 소프트하게, 변화하기 쉽게 남겨두어야 합니다.

### 비즈니스 로직

비즈니스 정책이나 룰은 프로젝트의 다른 어떤 부분보다 변화하기 쉽기 때문에 유연한 포맷을 통해 유지보수하는 것이 좋습니다.

다소 덜 복잡한 로직은 소형 언어를 통해 표현할 수 있으며, 그렇게 하면 환경이 바뀔 때마다 재컴팡닐, 재배포하지 않아도 됩니다.

### 엔터프라이즈 자바빈즈

EJB는 애플리케이션을 설정하고 코드 작성의 복잡도를 줄이기 위해 어떻게 메타데이터를 사용하면 되는지에 대한 좋은 사례입니다.

특정 규약을 따르는 자족적 객체인 빈을 작성하고, 이것에 대해 여러 하위 세부사항을 관리해주는 빈 컨테이너에 넣어주기만 하면 됩니다.

EJB는 메타데이터를 사용하여 트랜잭션이 어떻게 처리되어야 하는지를 지정하기 때문입니다.

이러한 메타데이터 분리로 환경을 런타임에 동적으로 설정할 수 있는 유연함을 제공합니다.

EJB와 같은 분산 시스템은 우리르 설정 가능하고 동적인 시스템이라는 새로운 세계로 안내해줍니다.

## 시간적 결합

소프트웨어의 설계 요소 자체로서의 시간의 역할은 두 가지 측면이 있습니다.

동시성과 순서입니다.

아키텍처를 설계하거나 프로그램을 짜기 시작할 때 보통 직선적 사고를 하는데 이렇게 생각하다 보면 시간적 결합, 즉 시간 측면에서의 결합을 만들게 됩니다.

우리는 동시성을 허용할 필요가 있고 시간이나 순서에 따른 의존성의 결합을 끊는 방법에 대해 알아야 합니다.

### 작업흐름

프로젝트에서 요구사항 분석의 일부로서 사용자들의 작업흐름을 모델화하고 분석하는 작업이 필요합니다.

이때, UML 활동 다이어그램 같은 표기법을 사용해 사용자들이 기술해준 작업흐름을 기록하는 방법을 사용합니다.

활동 다이어그램을 사용하면 동시에 수행될 수 있지만 아직그렇지 않는 활동들을 찾아내 병렬성을 극대화할 수 있습니다.

만약, 행동들을 순차적으로 기술했다고 하더라도 활동 다이어그램에서 는 병행해서 실행할 수 있음을 알 수 있고 의존성이 실제로 어디에 존재하는지 알 수 있습니다.

```
📌  작업흐름 분석을 통해 동시성을 개선하라.
```

### 아키텍처

시간적 결합 끊기를 활용함으로서 시스템을 작성하기 쉬워졌습니다.

배고픈 소비자 모델은 중앙 일정 관리자 대신 여러 개의 독립적인 소비자 작업들과 중앙 집중식 작업 큐를 사용하는데 이를 사용하면 개별 컴포넌트들은 자기 속도에 맞추어 일을 진행할 수 있고, 각 컴포넌트들은 서로 시간적 결합이 끊기게 됩니다.

```
📌  서비스를 사용해서 설계하라.
```

잘 정의되고 일고나성 있는 인터페이스 뒤에서 일하는 독립적이고 동시적인 객체들을 만들 수 있습니다.

### 동시성을 고려한 설계

다중쓰레드 프로그래밍을 쓰게 되면서 프로그래밍은 몇 가지 설계상의 제약을 받게 되었는데 이 것은 좋은 일입니다.

이 제약들은 코드의 결합을 끊고 기존 직선형 코드에서 전제들을 남발하는 것은 막을 수 있습니다.

동시성을 염두에 둔다면 여러 가지 일들을 더 주의 깊게 생각하게 될 수 있기 때문입니다. 갑자기 전에 못 보던 기산에 관련된 의존성들이 보이기 시작합니다.

- 모든 전역 변수난 정적 변수들을 동시 접근으로부터 보호해야 합니다.
- 호출 순서와 관계없이 일관성 있는 상태 정보를 보일 수 있는지도 확인해야 합니다.

동시성 시스템에서는 객체는 호출될 때 언제나 유효한 상태로 있어야 합니다.

동시성과 시간 순서에 딸느 의존성을 고려하는 것은 더 깔끔한 인터페이스를 설계하는 방향으로 시스템을 야기합니다.

```
📌 언제나 동시성을 고려해 설계하라.
```

### 배치

동시성 요소가 포함된 아키텍처를 설계한 다음에는, 수많은 동시적 서비스들을 다루는 것에 대해 생각하기 더 쉬워집니다. 

동시성 모델은 도처에 스며듭니다.

시스템을 독립적인 서비스들로 구성된 아키텍처로 만듦으로써, 설정 역시 동적으로 만들 수 있는데 동시성을 이용하지 않기로 서택한, 독립 애플리케이션을 포함해 모든 옵션을 다 이용할 수 있습니다.

동시성을 허용하도록 설계한다면, 확장가능성이나 성능에 대한 요구사항이 들어올 때 더 쉽게 그것에 맞추어 줄 수 있으며, 그런 일이 들어오지 않더라도 여전히 깔끔한 설계의 이점을 누릴 수 있습니다.

## 단지 뷰일 뿐이야

'잘 정의 된 단 하나의 책임만 가지는 것'이라는 말이야말로 모듈에 대한 좋은 정의가 됩니다.

프로그램을 책임에 따른 여러 모듈로 나눈 다음에도 새로운 문제가 발생하게 됩니다.

바로, 여러 다른 객체들의 상태 변화를 어떻게 동기화를 할 수 있을까에 대한 문제입니다.

이 문제는 이벤트를 이용하면 해결할 수 있습니다.

이벤트는 어떤 객체의 상태 변화를 이에 관심을  가질 다른 객체들에게 알릴 수 있습니다.

이벤트를 이용하면 직접적인 지식을 가질 필요가 없기 때문에 객체들 사이의 결합을 최소화 할 수 있습니다. 

하지만 이벤트를 이용하려면 약간 조심스러워야 합니다.

### 출판/구독

모든 이벤트를 루틴 하나에 몰아넣는 일은 여러 객체들 사이의 상호작용에 대한 상세한 지식을 지니게 하고 결합도를 증가시켜 객체 캡슐화에 위배되기 때문에 문제가 됩니다.

객체들 역시 이벤트에 대한 지식을 가져야만 하기에 **객체가 자기가 필요한 이벤트들만 구독해 받아보고 필요하지 않은 이벤트들은 받아오지 않도록 해야합니다.**

이를 위해 출판/구독 프로토콜을 사용합니다.

→ 출판자가 흥미로운 이벤트를 발생시키면, 출판자는 차례대로 구독자를 호출해 이벤트가 일어났다고 알려주고 중요한 이벤트라면 등록을 했든 안했든 모든 수신자에게 전송하는 방식을 운영할 수 있습니다.

### 모델-뷰-컨트롤러

데이터를 여러곳에 중복해 두고 싶지 않을 떄 모델(데이터 자체와 데이터를 조작하는 공통 연산)을 만들고 여러 방식으로 데이터를 보여주는 독립된 뷰를 만들고, 뷰마다 자신만의 컨트롤러를 가지는 설계 개념입니다.

컨트롤러는 데이터 자체에는 아무 영향을 미치지 않고 오직 뷰에만 영향을 미칩니다.

**모델을 표시하느 뷰 그리고 뷰를 관리하는 컨트롤러에서 모델을 분리해 내는 것**이 모델-뷰-컨트롤러 이디엄의 핵심 개념입니다.

장점

- 동일한 데이터 모델에 여러 뷰 둘 수 있습니다.
- 여러 다른 데이터 모델을 보는 공통된 뷰를 만들 수 있습니다.
- 일반적이지 않은 입력 메커니즘을 지원하는 컨트롤러를 여럿 둘 수 있습니다.
- 적은 비용으로 큰 유연성을 얻을 수 있습니다.

```
📌  모델에서 뷰를 분리하라.
```

보통 MVC는 보통 GUI 개발이라고 생각하지만 사실은 일반적으로도 쓸 수 있는 프로그래밍 기법입니다.

- 모델 : 대상 객체를 나타내는 추상 데이터 모델
    
    → 모델은 어떤 뷰나 컨트롤러에 대해서도 직접적인 지식을 지니지 않습니다.
    
- 뷰 : 모델을 해석하는 방법(그래픽과 상관 X)
    
    → 뷰는 모델의 변화 그리고 컨트롤러가 보내는 논리적 사건을 구독합니다.
    
- 컨트롤러 : 뷰를 제어하고 모델에 새로운 데이터를 제공하는 방법(어떤 입력장치와 연결 X)
    
    → 모델과 뷰 둘 모두에 이벤트를 보냅니다.
    

각 뷰마다 흥미로운 이벤트들을 통보하는 이벤트를 생성하게 한 다음, 한 차원 더 높은 객체가 어떤 것을 보일지 조정하면 뷰 객체들이 고차원 객체가 되어 버리고 고차우너 객체 역시 여러 형식으로 정보를 나타내는 다른 뷰들의 모델이 될 수 있습니다.

각 링크마다 원본 데이터와 그 데이터를 만드는 이벤트 사이의 결합을 끊게되면 모든 새로운 뷰는 또 다른 추상화입니다.

복잡한 시스템이라면 디버깅 뷰를 만들어 모델의 상세한 내부 정보를 보여주게 되면 유용할 수 있습니다.

## 칠판

컴퓨터 기반의 칠판 시스템은 원래 음성 인식, 지식 기반 추론 시스템 등등 해결해야 할 문제의 규모가 크고 복잡한 인공 지능 애플리케이션에서 사용할 목적으로 발명되었습니다.

단지 데이터가 아닌 객체의 흐름에 기반한 알고리즘을 설게하는 데 칠판을 이용합니다.

칠판에 대한 일관성 있는 인터페이스 하나만 있으면 된다는 점이 시스템의 큰 장점이고 칠판을 이용하는 방식의 프로그래밍을 하면 많은 인터페이스가 필요 없어지기에 더 우아하고 일관성 있는 시스템을 만들 수 있습니다.

```
📌  칠판을 사용해 작업흐름을 조율하라.
```

참여하는 요소들의 독립성과 심지어는 고립성을 유지하는 송시에 이질적인 사실과 행위자들을 잘 조장하는데 칠판을 사용할 수 있습니다.