# 데이터베이스 테스트

## 데이터베이스 테스트를 위한 전제 조건

소스 코드와 함께 소스 제어 시스템에 데이터베이스 스키마를 저장한다. 
데이터베이스 스키마는 테이블, 뷰, 인덱스, 저장 프로시저 및 데이터베이스 구성 방식의 blueprint를 형성하는 기타 모든 것으로 구성된다.

### 참조 데이터도 데이터베이스 스키마다

참조 데이터도 데이터베이스 스키마의 일부다. 응용 프로그램이 제대로 작동하려면 미리 채워야 하는 데이터다. 
- 일반 데이터: 애플리케이션이 해당 데이터를 수정할 수 있음
- 참조 데이터: 애플리케이션이 해당 데이터를 수정할 수 없음

### 모든 개발자를 위한 별도의 데이터베이스 인스턴스

모든 개발자를 위한 별도의 데이터베이스 인스턴스가 있다. 더 나은 방법은 최대 테스트 실행 속도를 위해 개발자 자신의 컴퓨터에서 해당 인스턴스를 호스팅하는 것이다.

### 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포

데이터베이스 전달에 대한 상태 기반 접근 방식은 상태를 명시적으로 만들고 비교 도구가 마이그레이션을 암시적으로 제어할 수 있도록 한다. 
마이그레이션 기반 접근 방식은 데이터베이스를 한 상태에서 다른 상태로 전환하는 명시적 마이그레이션의 사용을 강조한다. 

데이터 동작을 처리하는 것이 병합 충돌보다 훨씬 더 중요하기 때문에 상태 기반보다 마이그레이션 기반 접근 방식을 선호하자. 
마이그레이션을 통해 모든 수정 사항을 데이터베이스 스키마(참조 데이터 포함)에 적용한다.
## 데이터베이스 트랜잭션 관리
비즈니스 운영은 데이터를 원자적으로 업데이트해야 한다. 원자성을 달성하려면 기본 데이터베이스의 트랜잭션 메커니즘에 의존하자.

가능하면 작업 단위 패턴을 사용하자. 
작업 단위는 기본 데이터베이스의 트랜잭션에 의존한다. 비즈니스 운영이 끝날 때까지 모든 업데이트를 연기하여 성능을 향상시킨다.
테스트 섹션 간에 데이터베이스 트랜잭션 또는 작업 단위를 재사용하지 마라. 각 배열, 작업 및 주장 섹션에는 자체 트랜잭션 또는 작업 단위가 있어야 한다.

## 테스트 데이터 생명 주기
### 병렬 테스트 실행과 순차적 테스트 실행

통합 테스트를 순차적으로 실행한다. 병렬 실행에는 상당한 노력이 필요하며 일반적으로 그만한 가치가 없다.

### 테스트 실행 간 데이터 정리

테스트 시작 시 남은 데이터를 정리한다. 
이 접근 방식은 빠르게 작동하고 일관성 없는 동작을 일으키지 않으며 실수로 정리 단계를 건너뛰는 경향이 없다.

### 인메모리 데이터베이스 피하기

SQLite와 같은 메모리 내 데이터베이스를 피하라. 테스트가 다른 공급업체의 데이터베이스에 대해 실행되는 경우 보호를 받을 수 없다. 테스트에서 프로덕션에서와 동일한 데이터베이스 관리 시스템을 사용하라.

## 테스트 구절에서 코드 재사용하기

필수적이지 않은 부분을 private 메서드나 helper 클래스로 추출하여 테스트를 단축한다.
- 정렬 섹션: Test Data Builder보다 Object Mother를 선택
- 행위: 데코레이터 메서드를 만들자 
- assert: 인터페이스 도입

### 리포지터리 테스트를 해야 하는가?

리포지토리를 직접 테스트하지 말고 가장 중요한 통합 테스트 제품군의 일부로만 테스트하라. 리포지토리에 대한 테스트는 회귀에 대한 보호의 추가 이점이 너무 적기 때문에 유지 관리 비용이 너무 많이 든다.
