# 10.   데이터베이스 테스트

## 1. 데이터베이스 테스트를 위한 전제 조건

- 형상 관리 시스템에 데이터베이스 유지
- 개발자마다 별도의 데이터베이스 인스턴스 사용
- 데이터베이스 배포에 마이그레이션 기반 방식 적용

**데이터베이스를 형상 관리 시스템에 유지**

데이터베이스를 테스트하는 방법

1. 데이터베이스 스키마를 일반 코드로 취급하는 것이다.

모델 데이터베이스를 사용하는 것은 데이터베이스 스키마를 유지한느 데 상당히 좋지 않다.

- 변경 내역 부재 : 데이터베이스 스키마를 과거의 특정 시점으로 되돌릴 수 없다. 이는 운영 환경에서 버그를 재현할 때 중요할 수 있다.
- 복수의 원천 정보 : 모델 데이터베이스는 개발 상태에 대한 원천 정보를 둘러싸고 경합하게 된다. 이렇게 기준을 두 가지로 두면 부담이 가중된다.

반면 모든 데이터베이스 스키마 업데이트를 형상 관리  시스템에 두면 원천 정보를 하나로 할 수 있고, 일반 코드 변경과 함꼐 추적 할 수 있다.

**참조 데이터도 데이터베이스 스키마다.**

> 정의 - 참조 데이터는 애플리케이션이 제대로 작동하도록 미리 채워야 하는 데이터다.
구분방법 : 애플리케이션이 데이터를 수정 할 수 있으면 일반 데이터이고, 그렇지 않으면 참조 데이터다.
> 

참조데이터는 일반데이터와 별도로 저장되지만, 두 데이터가 공종하는 경우도 있는 수정 가능 데이터와 불가능 데이터를 구분하는 플래그를 두고,참조 데이터의 변경을 막아야 한다.

**모든 개발자를 위한 별도의 데이터베이스 인스턴스**

공유 데이터베이스를 사용하면 개발 프로세스를 방해하게 된다.

- 서로 다른 개발자가 실행한 테스트는 간섭되기 때문이다.
- 하위 호완성이 없는 변경으로 다른 개발자의 작업을 막을 수 있기 때문이다.

테스트 실행 속도를 극대화 하려면 별도로 데이터베이스를 인스턴스 사용하라.

**상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포**

배포의 2가지 방식

- 상태 기반
- 마이그레이션 기반 : 초기에는 구현하고 유지보수하기 어렵지만 장기적으로는 상태 기반방식보다 훨씬 효과적이다.

상태기반 방식은 상태를 형상 관리에 저장함으로써 상태를 명시하고 비교 도구가 마이그레이션을 암묵적으로 제어할 수 있게 한다.

마이그레이션 기반 방식은 마이그레이션을 명시적으로 하지만 상태를 암묵적으로 둔다. 데이터베이스 사애를 직접 볼 수 없으며 마이그레이션으로 조합해야 한다.

## 2. 데이터베이스 트랜잭션 관리

트랜잭션을 잘 사용하면 잠재적인 모순을 피할 수 있는데

잠재적 모순을 피하려면 결정 유형을 두 가지로 나눠야 한다.

- 업데이트 할 데이터
- 업데이트 유지 또는 롤백 여부

DB클래스를 repository와 Transaction 나눠서 책임을 구분할 수 있다.

- repo는 db의 데이터에 대한 접근과 수정을 가능하게 하는 클래스다.
- transaction은 데이터 업데이트를 완전히 커밋하거나 롤백하는 클래스다. 데이터 수정의 원자성 확보를 위해 기본 db 트랜잭션에 의존하는 사용자 정의 클래스다.

repo와 tran을 도입하면 잠재적 데이터 모순을 피할 수 있지만 더 좋은 방법은 transaction클래스를 작업 단위로 업그레이드 할 수 있다.

**통합 테스트에서 데이터베이스 트랜잭션 관리하기**

테스트 구절 간에 데이터베이스 트랜잭션이나 작업 단위 재사용하지 말라.

> 통합 테스트에서 적어도 세 개의 트랜잭션 또는 작업 다위를 사용하라(준비, 실행 ,검증 구절당 하나씩)
> 

## 10.3 테스트 데이터 생명 주기

공유 데이터베이스를 사용하면 통합 테스를 서로 분리할 수 없는 문제가 생긴다.

이는

- 통합 테스트를 순차적으로 실행하라
- 테스트 실행 간에 남은 데이터를 제거하라

**병렬 테스트 실행과 순차적 테스트 실행**

대부분 단위 테스트 프레임워크는 별도의 테스트 모음을 정의하고 일부에 대해 병렬 처리를 비활성화할 수 있따. 두가지와 테스트군을 만들고 통합 테스트군은 테스트 병렬 처리를 비활성화한다.

통합 테스트의 실행 시간을 최소화해야 하는 경우가 아니라면 컨테이너를 사용하지 않는 것이 좋다. 

DB는 개발자당 하나의 인스턴스만 갖는 것이 실용적이다. 이런건 도커로 실행할 수 있다.

**테스트 실행 간 데이터 정리**

테스트 실행 간에 남은 데이터를 정리하는 방법은 네 가지가 있다.

- 각 테스트 전에 데이터베이스 백업 복원하기
- 테스트 종료 시점에 데이터 정리하기
- 데이터베이스 트랜잭션에 각 테스틀를 래핑하고 커밋하지 않기
- 테스트 시작 시점에 데이터 정리하기

> 별도의 종료 단계는 필요 없다. 준비 구절에 구현하라
> 

**인메모리 데이터 베이스 피하기**

인메모리 db의 장정

- 테스트 데이터를 제거할 필요가  없음
- 작업 속도 향상
- 테스트가 실행될 때마다 인스터스화 가능

이런 장점에도 일반 DB와 기능적으로 일관성이 없기 때문에 사용하지 않는 것이 좋다. 이는 거짓음성이 발생하기 쉬워진다.

> 테스트에서도 운영 환경과 같은 데이터베이스 관리 시스템을 사용하라. 보통 버전이 달라도 괜찮지만, 공급업체는 같아야 한다.
> 

## 테스트 구절에서 코드 재사용하기

통합 테스트는 가능한 짧게 하되 서로 결합하거나 가독성에 영향을 주지 않는 것이 중요하다.

통합 테스트를 짧게 하기에 가장 좋은 방법은 비즈니스와 관련이 없는 기술적인 부분을 비공개 메서드나 헬퍼 클래스로 추출하는 것이다.

**준비 구절에서 코드 재사용하기**

테스트 준비 구절 간에 코드를 재사용하기에 가장 좋은 방법은 비공개 팩토리 메서드를 도입하는 것이다.

**실행 구절에서 코드 재사용하기**

모든 통합 테스트의 실행 구절에서 데이터베이스 트랙잭션이나 작업 단위를 만든다.

**검증 구절에서 재사용하기**

헬퍼 메서드를 두는 것

## 데이터베이스 테스트에 대한 일반적인 질문

**읽기 테스트를 해야 하는가?**

읽기 테스트 임계치는 쓰기 테스트 임계치보다 높아야 한다. 가장 복잡하거나 중요한 읽기 작업만 하고 나머지는 무시하라. 읽기를 테스트하기로 결정한 경우에는 실제 데이터베이스에서 통합 테스트를 하라.

**Repo를 테스트를 해야 하는가?**

테스트의 유지비가 높고 회귀 방지가 떨어져서 테스트 스위트에 손실이 된다.

그러므로 Repo는 직접 테스트하지 말고, 통합 테스트 스위트의 일부로 취급하라.
