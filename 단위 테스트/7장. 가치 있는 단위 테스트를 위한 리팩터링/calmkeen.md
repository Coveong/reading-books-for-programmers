# 7. 가치 있는 단위 테스트를 위한 리팩터링

## 7.1 리팩터링할 코드 식별하기

모든 제품 코드는 2차원으로 분류할 수 있다.

- 복잡도 또는 도메인 유의성
- 협력자 수

도메인 유의성은 코드가 프로젝트의 문제 도메인에 대해 얼마나 의미있는지

복잡한 코드와 도메인 유의성을 갖는 코드가 단위 테스트에서 가장 이롭다.( 회귀방지가 뛰어나기 때문)

협력자가 많은 코드는 테스트비용이 많이 든다.

[ 코드 유형 ]

<img width="438" alt="image" src="https://user-images.githubusercontent.com/78361650/195021049-e8912597-8b93-433e-97e0-22873d1674fe.png">


가장 문제가 되는 코드 유형은 지나치게 복잡한 코드다. 단위 테스트가 어렵겠지만 테스트 커버리지 없이 내버려두는 것은 너무 위험하다.

> 좋지 않은 테스트를 작성하는 것 보다는 테스트를 전혀 작성하지 않는 편이 낫다.
> 

### 7.1.2 험블 객체 패턴을 사용해 지나치게 복잡한 코드 분할하기

험블 객체 패턴은 지나체게 복잡한 코드에서 로직을 추출해 코드를 테스트 할 필요가 없도록 간단한게 만든다. 추출된 로직은 테스트하기 어려운 의존성에서 분리된 다른 클래스로 이동한다.

<img width="435" alt="image" src="https://user-images.githubusercontent.com/78361650/195021311-4ea2fed7-9f36-4878-8a00-f70c4f37e218.png">



함수형  아키텍처는 더 나아가 프로세스 외부 의존성뿐만 아니라 협력자와의 커뮤니케이션에서 비즈니스 로직을 분리한다.

험블객체패턴을 보는 또 다른 방법은 단일 책임 원칙을 지키는 것이다. 예를 들자면 비즈니스 로직과 오케스트레이션을 분리하는 경우다.

> 오케스트레이션이란?
시스템 관리에서 오케스트레이션은 컴퓨터 시스템과 소프트웨어의 자동화된 구성, 조율, 관리 
-출처 : wiki -
> 

7.2 가치 있는 단위 테스트를 위한 리팩터링하기

1.  암시적 의존성을 명시적으로 만들기
- 데이터베이스와 메시지 버스에 대한 인터페이스를 두고 인터ㅔ이스를 주한한 후 테스트에서 목으로 처리
- 도메인 모델은 직접적으로든 간접적으로든 프로세스 외부 협력자에게 의존하지 않는것이 깔끔하다.
- 도메인 모델은 외부 시스템과 통신을 책임지지 않아야 한다.
2. 애플리케이션 서비스 계층 도입
- 도메인 클래스는  단순 값과 같은  프로세스 내부 의존성에만 의존해야 한다.
3. 애플리케이션 서비스 복잡도 낮추기
-ORM을 사용하지 않거나 사용할 수 없으면, 도메인 모델에 원시 데이터베이스 데이터로 도메인클래스를 인스턴스화 하는 팩토리 클래스를 작성하라.

## 7.3 최적의 단위 테스트 커버리지 분석

비지니스 로직과 오케스트레이션을 완전히 분리하면 코드베이스의 어느 부분을 테스트단위로 할지 쉽게 결정할 수 있다.

일반적으로 권장하는 지침은 도메인 유의성이 있는 모든 전제 조건을 테스트하라는 것이다.

## 7.4 컨트롤러에서 조건부 로직 처리

비즈니스  연산의 3단계

- 저장소에서 데이터 검색
- 비즈니스 로직 실행
- 데이터를 다시 저장소에서 저장

맞춰야할 특성의 균형

- 도메인 모델 테스트 유의성: 도메인 클래스의 협력자 수와 유형에 따른 함수
- 컨트롤 단순성: 의사 결정 지점이 있는지에 따라 다름
- 성능: 프로세스 외부 의존성에 대한 호출 수로 정의

> 위에서 말한 세가지 특성중 두가지 특성만 갖는다. 모두 충족하는 방법은 없다.
> 

CanExcute/Excute패턴 사용

- 컨트롤러는 프로세스를 알 필요가 없다. 메서드를 호출해서 확인만 한다.
- 이패턴을 사용하면 도메인 계층의 모든 결정을 통합할 수 있다.

도메인 이벤트를 사용해 도메인 모델 변경 사항 추적

> 참고; 도메인 이벤트는 이미 일어난 일들을 나타내기 떄문에 항상 과거 시제로 명명해야한다.
> 

도메인 이벤트는 컨트롤러에서 의사 결정 책임을 제거하고 해당 책임을 도메인 모델에 적용함으로써 외부 시스템과 통신에 대한단위 테스트를 간결하게 한다.

## 결론

추상화할 것을 테스트하기보다 추상화를 테스트하는 것이 더 쉽다.

컨트롤러에 비지니스 로직이 있는것을 피할 수 없는 것처럼, 도메인 크랠스에서 모든 협력자를 제거할 수 있는 경우는 거의 없을 것이다.

식별할수 있는 동작이 되려면 메서드는 두가지중 하나를 충족해야 한다.

- 클라이언트 목표 중 하나에 직접적인 연관이 있음
- 외부 애플리케이션에서 볼 수 있는 프로세스 외부 의존성에서 부작용이 발생함

식별할수 있는 동작과 구현 세부 사항을 양파의 여러 겹으로 생각하고, 각 계층을 테스트하고, 어떻게 통신하는지는 무시하라.

이미지 참조

7.1.2 이미지 : [https://velog.io/@youngerjesus/단위-테스트-리뷰-zwrdhz3chttps://velog.io/@youngerjesus/단위-테스트-리뷰-zwrdhz3c](https://velog.io/@youngerjesus/%EB%8B%A8%EC%9C%84-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%A6%AC%EB%B7%B0-zwrdhz3c)
