# 7장 가치 있는 단위 테스트를 위한 리팩터링

## 1. 리팩터링할 코드 식별하기

기반 코드를 리팩터링하지 않고서는 테스트 스위트를 크게 개선할 수 없습니다.

### 코드의 네 가지 유형

모든 제품 코드는 2차원으로 분류할 수 있습니다.

- 복잡도 또는 도메인 유의성
    - 코드 복잡도: 코드 내 의사 결정 지점 수로 정의함
    - 도메인 유의성: 코드가 프로젝트의 문제 도메인에 얼마나 의지 있는 지
- 협력자 수
    - 클래스 또는 메서드가 가진 가변 의존성, 프로세스 외부 의존성 수

![Untitled](7%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A1%E1%84%8E%E1%85%B5%20%E1%84%8B%E1%85%B5%E1%86%BB%E1%84%82%E1%85%B3%E1%86%AB%20%E1%84%83%E1%85%A1%E1%86%AB%E1%84%8B%E1%85%B1%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%B5%E1%84%91%E1%85%A2%E1%86%A8%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%2092cdf7764c2e4ea3ab4080b1d379afcb/Untitled.png)

- 도메인 모델 및 알고리즘
- 간단한 코드
    - 테스트 할 필요가 없음
- 컨트롤러
- 지나치게 복잡한 코드
    - 가장 문제가 되는 유형으로 단위 테스트는 어렵지만, 테스트 커버리지 얺이 내버려두는 것은 위험함

<aside>
💡 코드가 더 중요해지거나 복잡해질수록 협력자는 더 적여야 합니다.

</aside>

지나치게 복잡한 코드를 피하고 도메인 모델과 알고리즘만 단위 테스트하는 것이 매우 가치있고 유지 보수가 쉬운 테스트 스위트로 가는 길입니다. 복잡한 코드를 알고리즘과 컨트롤러로 나눠서 리팩터링 해야 합니다.

### 험블 객페 패턴을 사용해 지나치게 복잡한 코드 분할하기

험블 객체 패턴을 사용해 지나치게 복잡한 코드를 쪼갤 수 있습니다. 육각형 아키텍처는 비즈니스 로직과 프로세스 외부 의존성과의 통신을 분리합니다.

험블 객체 패턴은 단일 책임 원칙을 지킵니다. 프리젠터와 컨트롤럴 구성 요소는 험블 객체로, 뷰와 모델을 붙입니다. 

## 2. 가치 있는 단위 테스트를 위한 리팩터링하기

1단계: 암시적 의존성을 명시적으로 만들기

2단계: 애플리케이션 서비스 계층 도입

3단계: 애플리케이션 서비스 복잡도 낮추기

4단계: 새로운 협력자 클래스 생성하기

## 3. 최적의 단위 테스트 커버리지 분석

비즈니스 로직과 오케스트레이션을 완전히 분리하면 코드베이스의 어느 부분을 테스트단위로 할지 쉽게 결정할 수 있습니다.

일반적으로 전제 조건을 모두 테스트하는 것 보다는 도메인 유의성이 있는 모든 전제 조건을 테스트해야 합니다.

## 4. 컨트롤러에서 조건부 로직 처리

조건부 로직을 처리하면서 동시에 프로세스 외부 협력자 없이 도메인 계층을 유지 보수하려면 절충이 필요합니다.

비즈니스 로직과 오케스트레이션의 분리는  비즈니스 연산이 세 단계로 나눠질 때 가장 효과적입니다.

- 저장소에서 데이터 검색
- 비즈니스 로직 실행
- 데이터를 다시 저장소에 저장

## 정리

- 코드 복잡도는 코드에서 의사 결정 지점 수에 따라 명시적으로(코드) 그리고 암시적으로(코드가 사용하는 라이브러리) 정의된다.
- 도메인 유의성은 프로젝트의 문제 도메인에 대해 코드가 얼마나 중요한지를 보여준다.
- 복잡한 코드와 도메인 유의성을 갖는 코드는 해당 테스트의 회귀 방지가 뛰어나기 때문에 단위 테스트에 가장 이롭다.
- 협력자가 많은 코드를 다루는 단위 테스트는 유지비가 많이 든다.
- 모든 제품 코드는 네 가지 유형의 코드로 분류할 수 있다.
    - 도메인 모델 및 알고리즘 (단위 테스트에 대한 노력 대비 가장 이롭다.)
    - 간단한 코드 (테스트할 가치가 전혀 없다.)
    - 컨트롤러 (통합 테스트를 통해 간단히 테스트해야 한다.)
    - 지나치게 복잡한 코드 (컨트롤러와 복잡한 코드로 분할해야 한다.)
- 코드가 중요하거나 복잡할수록 협력자가 적어야 한다.
- 험블 객체 패턴
- 육각형 아키텍처와 함수형 아키텍처는 험블 객체 패턴을 구현한다.
    - 육각형 아키텍처: 비즈니스 로직과 프로세스 외부 의존성과의 통신 분리
    - 함수형 아키텍처: 비즈니스 로직과 프로세스 외부 의존성 포함한 모든 협력자와의 통신 분리

- 도메인 유의성이 있으면 전제 조건을 테스트하고, 그 외의 경우에는 테스트하지 않는다.
- 비즈니스 로직과 오케스트레이션 분리 시 중요한 특성 세 가지
    - 도메인 모델 테스트 유의성
    - 컨트롤러 단순성
    - 성능
-