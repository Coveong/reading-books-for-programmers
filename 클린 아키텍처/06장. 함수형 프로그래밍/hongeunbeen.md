# 06장. 함수형 프로그래밍

# 함수형 프로그래밍이란?

일단, 함수형 프로그래밍을 설명하기 위해 예제를 하나 보겠습니다.

```java
public class Squint {
	public static void main(String args[]) {
		for (int i=0; i<25; i++) {
			System.out.println(i*i);
		}
	}
}
```

위 예제는 25까지의 정수의 제곱을 출력하는 예제입니다. 

이 예제를 리스프에서 팡생한 클로저라는 함수형 언어로 구현하면

```clojure
(println (take 25 (map (fn [x] (* x x)) (range))))
```

🤯  함수형 언어가 낮설다면 이 코드가 어려워 보이실 텐데요!

더 보기 쉽게 주석처리를 해보겠습니다.

```clojure
(println ; ___ 출력한다.
	(take 25 ; ___ 처음부터 25까지
		(map (fn [x] (* x x)) ; ___ 제곱을
			(range)))); ___ 정수의
```

리스트에서는 함수를 괄호 안에 넣는 방식으로 호출합니다.

- (range) → range 함수 호출

이제, 코드를 분석해 볼텐데 리스프는 함수 호출부터 시작하는게 좋습니다.

- `range` 함수
    - 0부터 끝이 없는 정수 리스트 반환
- 반환된 정수 리스트 → `map` 함수 전달
    - 각 정수에 대해 제곱 계산 익명 함수 호출해 제곱에 대해 끝이 없는 리스트 생성
- 제곱된 리스트 → `take` 함수 전달
    - 함수는 앞의 25개까지의 항목으로 구성된 새로운 리스트 반환
- println 함수 → 입력값 출력
    - 앞의 25개의 정수에 대한 제곱 값으로 구성된 리스트 출력

이렇게 함수형 언어와 자바의 코드를 비교해 봤는데요! 이 두 언어에는 극단적인 차이가 있습니다.

자바 프로그램은 가변 변수(`i`)를 사용하는데, 함수형 언어에 변수는 변경되지 않습니다.

# 불변성과 아키텍처

🤔 앞에서 살펴본 가변변수, 즉 변수의 가변성을 왜 염려해야 할까요?

→ 경합 조건, 교착 상태 조서느, 동시 업데이트 문제는 모두 가변 변수로 인해 발생하기 때문입니다.

동시성 애플리케이션의 모든 문제, 즉 다수의 스레드와 프로세스를 사용하는 애플리케이션에서 마주치는 모든 문제는 가변 변수가 없다면 절대로 생기지 않습니다.

🤔 그럼, 불변성이 정말 실현 가능할까요?

→ 불변성은 실현 가능하겠지만 일종의 타협이 필요합니다.

# 가변성의 분리

불변성과 관련한 가장 주요한 타협은 **애플리케이션 내부의 서비스를 가변 컴포넌트와 불변 컴포넌트로 분리하는 일**입니다.

불변 컴포넌트 

- 순수하게 함수형 방식으로만 작업 처리
- 어떤 가변 변수도 사용 X
- 변수의 상태를 변경할 수 있는, 즉 순수 함수형 컴포넌트가 아닌 하나 이상의 다른 컴포넌트와 서로 통신

가변 컴포넌트

- 트랜잭션 메모리를 사용해 동시 업데이트와 경합 조건 문제로부터 가변 변수 보호

트랜젝션 메모리

- DB가 디스크의 레코드를 다루는 방식과 동일한 방식으로 메모리의 변수 처리
- 트랜잭션을 사용하거나 또는 재시도 기법을 통해 변수 보호

결론은 불변성을 위해 

- 애플리케이션을 제대로 구조화하려면 변수를 변경하는 컴포넌트와 변경하지 않는 컴포넌트를 분리해야 합니다.
- 분리를 위해 가변 변수들을 보호하는 적절한 수단을 동원해 뒷받침 해야 합니다.

현명한 아키텍트라면 가능한 한 많은 처리는 불변 컴포넌트로 옮기고 가변 컴포넌트에는 가능한 한 많은 코드를 빼내야 합니다.

또한, 더 많은 메모리를 확보할수록, 기계가 더 빨라질수록, 필요한 가변 상태는 더 적어집니다.!!

# 이벤트 소싱

🤔 그럼, 케이션의 수명주기 동안만 문제없이 동작할 정도의 저장 공간과 처리 능력만 있다면 발생한 트랜잭션을 단순히 저장하면 가변 변수를 줄일 수 있지 않을까요?

→ 이 개념이 바로 이벤트 소싱입니다! 

🤔 이벤트 소싱이란?

→ 상태가 아닌 트랜잭션을 저장하자는 전략입니다. 상태가 필요해지면 단순히 상태의 시작점부터 모든 트랜잭션을 처리합니다.

이렇게 전략을 사용하게 된다면 이젠 데이터 저장소에서 삭제되거나 변경되는 것이 하나도 없어지는데...

결과적으로는 애플리케이션은 CRUD가 아닌 CR만 수행합니다..!

업데이트와 관련한 문제가 발생하지 않는데요!! 

저장 공간과 처리 능력이 충분하다면 애플리케이션이 완전한 불변성을 갖도록 만들 수 있고, 따라서 완전한 함수형으로 만들 수 있습니다.