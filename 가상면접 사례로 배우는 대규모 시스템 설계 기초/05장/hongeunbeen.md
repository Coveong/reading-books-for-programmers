# 5장 안정 해시 설계

수평적 규모 확장성 달성

→ 요청 또는 데이터를 서버에 균등하게 분배 중요

## 해시 키 재배치(rehash) 문제

### [해시 함수]

> 해시 함수
- 임의의 길이를 갖는 임의의 데이터를 고정된 길이의 데이터로 매핑하는 단방향 함수
> 
- N개의 캐시 서버에 분하를 균등하게 나누는 보편적 방법
    
    ```
    serverIndex = hash(key) % N 
    ```
    
    - 서버의 개수 : N

### [키에 대한 해시값과 서버 인덱스 계산]

- 나머지 연산을 통해 특정한 키가 보관될 서버 구함
    
    ![Untitled](https://user-images.githubusercontent.com/37995685/186432862-24e9e732-ae28-48bf-89f0-3381bd5b77cf.png)
    
- 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 떄 잘 작동

### [문제점]

- 서버 추가/삭제 시 대규모 캐시 미스 발생 가능
    
    ![Untitled 1](https://user-images.githubusercontent.com/37995685/186432915-7859e46d-0af2-4703-8b04-0eba4bfb4d20.png)

    - 키에 대한 해시 값은 변하지 않지만 서버 인덱스 값이 달라져 엉뚱한 서버에 접속

**→ 안정 해시 사용해 해결**

## 안정 해시

> 안정 해시
- 해시 테이블 크기가 조정될 떄 평균적으로 오직 K(키의 개수)/N(슬롯의 개수) 개의 키만 재배치하는 해시 기술
> 

→ 이와 달리 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치

### [해시 공간과 해시 링]

- 해시 함수 : SHA-1
    
    > SHA
    - 서로 관련된 암호학적 해시 함수들의 모음
    > 
- 함수의 출력 값 범위 : x0 ~ xn
    - SHA-1의 해시 공간 범위 : 0 ~ 2^160 -1
    - x0 = 0
    - xn =  2^160 -1
- 해시 공간
    
    ![Untitled 2](https://user-images.githubusercontent.com/37995685/186432994-417eb34d-bb7b-4f36-a846-4bf175b83c2a.png)
    
    
- 해시 링 : 해시 공간의 양쪽을 구부려 접음
    
    ![Untitled 3](https://user-images.githubusercontent.com/37995685/186433015-5ca14dc1-02fb-4dfc-84ed-22f57cb27906.png)


### [해시 서버]

- 해시 함수 f를 사용해 4개의 서버를 해시 링 위에 배치
    
    ![Untitled 4](https://user-images.githubusercontent.com/37995685/186433044-b1c16fd1-d2eb-44cd-9457-482dce737da7.png)


### [해시 키]

- 캐시할 키 4개 해시 링 위의 어느 지점에 배치
    
    ![Untitled 5](https://user-images.githubusercontent.com/37995685/186433113-f2e642c6-a31f-4137-a95d-c617ada78857.png)


### [서버 조회]

- 어떤 키가 저장되는 서버 = 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버
    
    ![Untitled 6](https://user-images.githubusercontent.com/37995685/186433134-2ca8c669-b3de-4103-b8cb-32e1ba759e14.png)

    
    - key1 = 서버 1
    - key2 = 서버 2
    - key3 = 서버 3
    - key4 = 서버 4

### [서버 추가]

- 서버를 추가해도 키 가운데만 재배치하면 됨

    ![Untitled 7](https://user-images.githubusercontent.com/37995685/186433179-4714fd1f-7959-45e9-a62d-252bdba02b11.png) 

    - key0 시계 방향으로 순회했을 때 만나는 서버가 서버 4여서 재배치
    - 나머지 키는 영향 없음

### [서버 제거]

- 서버가 제거되어도 키 가운데 일부만 재배치

    ![Untitled 8](https://user-images.githubusercontent.com/37995685/186433258-f642d3ad-2d53-4e43-8be2-9dedebd01646.png)

    - key1 시계 방향으로 순회했을 때 만나는 서버가 서버 2여서 재배치
    - 나머지 키는 영향 없음

### [안정 해시 기본 구현법의 두 가지 문제]

- 안정 해시 알고리즘의 기본 절차
    1. 서버와 키를 균등 분호 해시 함수를 사용해 해시 링에 배치함
    2. 키의 위치에서 링을 시계방향으로 탐색 후 만나는 최초의 서버에 키가 저장됨
- 안정 해시 접근법에는 두 가지 문제 존재
    1. 서버 증설/제거 상황을 감안하면 파티션의 크기를 균등하게 유지하는 것 불가능
        
        > 파티션
        - 인접한 서버 사이의 해시 공간
        > 

        ![Untitled 9](https://user-images.githubusercontent.com/37995685/186433310-bed6a887-8dd8-4d0a-80a8-e15f9f14e187.png)

    2. 키의 균등 분포를 달성하기 어려움
        
        ![Untitled 10](https://user-images.githubusercontent.com/37995685/186433407-70b63b8f-3842-47e2-b319-73a914f9e47c.png)


### [가상 노드]

> 가상 노드
- 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있음
> 

![Untitled 11](https://user-images.githubusercontent.com/37995685/186433439-6f178f4f-f938-4eb5-bd5c-72a3545258d0.png)

- 각 서버는 하나가 아닌 여러 개 파티션을 관리함
- 가상 노드 장점
    - 가상 노드의 개수를 늘리면 표준 편차가 작아져, 키의 분포는 점점 더 균등해짐
    
    > 표준 편차
    - 데이터가 어떻게 퍼져 나갔는지를 보이는 척도
    > 
- 가상 노드 단점
    - 가상 노드 데이터를 저장할 공간이 더 많이 필요함
- **가상 노드 개수를 시스템 요구사항에 맞도록 적절히 조정해야 함**

### [재배치할 키 결정]

- 서버 추가
    - 새로 추가된 노드부터 반시계 방향에 있는 첫 번째 서버까지의 키 재배치
- 서버 제거
    - 삭제된 노드 반시계 방향에 있는 첫 번재 서버까지의 키 재배치

## 안정 해시의 이점

- 서버 증설/제거 시 재배치되는 키의 수 최소화
- 데이터가 균등하게 분포되어 수평적 규모 확장성 달성 가능
- 핫스팟 키 문제 줄임
    - 안정 해시는 데이터는 균등하게 분배하므로 특정한 샤드에 대한 접근이 빈번하면 일어나는 서버 과부화 문제 줄임

### [안정 해시 사용 기술]

- 아마존 다이나모 데이터베이스 파티셔닝 관련 컴포넌트
- 아파치 칸산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카마이 CDN
- 매그래프 네트워크 부하 분산기
